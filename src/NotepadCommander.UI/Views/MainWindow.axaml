<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:NotepadCommander.UI.ViewModels"
        xmlns:components="using:NotepadCommander.UI.Views.Components"
        xmlns:dialogs="using:NotepadCommander.UI.Views.Dialogs"
        xmlns:converters="using:NotepadCommander.UI.Converters"
        x:Class="NotepadCommander.UI.Views.MainWindow"
        x:CompileBindings="False"
        Title="{Binding TabManager.WindowTitle}"
        Width="1280" Height="800"
        MinWidth="800" MinHeight="500">

    <Window.Resources>
        <converters:PathToFileNameConverter x:Key="PathToFileNameConverter" />
    </Window.Resources>

    <Window.KeyBindings>
        <KeyBinding Gesture="Ctrl+N" Command="{Binding NewDocumentCommand}" />
        <KeyBinding Gesture="Ctrl+O" Command="{Binding OpenFileCommand}" CommandParameter="{Binding $self}" />
        <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveFileCommand}" CommandParameter="{Binding $self}" />
        <KeyBinding Gesture="Ctrl+Shift+S" Command="{Binding SaveFileAsCommand}" CommandParameter="{Binding $self}" />
        <KeyBinding Gesture="Ctrl+W" Command="{Binding CloseTabCommand}" />
        <KeyBinding Gesture="Ctrl+Tab" Command="{Binding NextTabCommand}" />
        <KeyBinding Gesture="Ctrl+Shift+Tab" Command="{Binding PreviousTabCommand}" />
        <KeyBinding Gesture="Ctrl+F" Command="{Binding ShowFindCommand}" />
        <KeyBinding Gesture="Ctrl+H" Command="{Binding ShowReplaceCommand}" />
        <KeyBinding Gesture="Ctrl+Z" Command="{Binding UndoCommand}" />
        <KeyBinding Gesture="Ctrl+Y" Command="{Binding RedoCommand}" />
        <KeyBinding Gesture="Ctrl+OemPlus" Command="{Binding ZoomInCommand}" />
        <KeyBinding Gesture="Ctrl+OemMinus" Command="{Binding ZoomOutCommand}" />
        <KeyBinding Gesture="Ctrl+D0" Command="{Binding ZoomResetCommand}" />
        <KeyBinding Gesture="F11" Command="{Binding ToggleFullScreenCommand}" />
        <KeyBinding Gesture="Ctrl+OemQuestion" Command="{Binding ToggleCommentCommand}" />
    </Window.KeyBindings>

    <DockPanel>
        <!-- Ruban -->
        <components:ToolbarTabControl DockPanel.Dock="Top"
                                      DataContext="{Binding ToolbarViewModel}" />

        <!-- Barre d'onglets documents -->
        <Border DockPanel.Dock="Top"
                Background="{DynamicResource TabBarBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="4,0"
                Height="36">
            <ScrollViewer HorizontalScrollBarVisibility="Auto"
                          VerticalScrollBarVisibility="Disabled">
                <ItemsControl ItemsSource="{Binding TabManager.Tabs}"
                              DragDrop.AllowDrop="True"
                              x:Name="TabBar">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="2" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Button Classes="btn-toolbar"
                                    Padding="10,6"
                                    ToolTip.Tip="{Binding FilePath}"
                                    Tag="{Binding}"
                                    Click="OnTabClick"
                                    PointerPressed="OnTabPointerPressed"
                                    DragDrop.AllowDrop="True">
                                <Button.ContextMenu>
                                    <ContextMenu>
                                        <MenuItem Header="Fermer"
                                                  Command="{Binding $parent[Window].DataContext.CloseTabCommand}"
                                                  CommandParameter="{Binding}" />
                                        <MenuItem Header="Fermer les autres"
                                                  Command="{Binding $parent[Window].DataContext.CloseOtherTabsCommand}"
                                                  CommandParameter="{Binding}" />
                                        <MenuItem Header="Fermer tout"
                                                  Command="{Binding $parent[Window].DataContext.CloseAllTabsCommand}" />
                                        <Separator />
                                        <MenuItem Header="Nouveau"
                                                  Command="{Binding $parent[Window].DataContext.NewDocumentCommand}" />
                                        <Separator />
                                        <MenuItem Header="Copier le chemin"
                                                  Command="{Binding $parent[Window].DataContext.CopyTabPathCommand}"
                                                  CommandParameter="{Binding}" />
                                        <MenuItem Header="Reveler dans l'explorateur"
                                                  Command="{Binding $parent[Window].DataContext.RevealInExplorerCommand}"
                                                  CommandParameter="{Binding}" />
                                    </ContextMenu>
                                </Button.ContextMenu>
                                <Grid ColumnDefinitions="*,Auto">
                                    <TextBlock Text="{Binding Title}"
                                               VerticalAlignment="Center"
                                               FontSize="12"
                                               Margin="0,0,8,0" />
                                    <Button Grid.Column="1"
                                            Classes="btn-icon"
                                            Width="20" Height="20"
                                            Padding="2"
                                            Command="{Binding $parent[Window].DataContext.CloseTabCommand}"
                                            CommandParameter="{Binding}"
                                            ToolTip.Tip="Fermer">
                                        <Viewbox Width="10" Height="10">
                                            <Path Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"
                                                  Fill="{DynamicResource TextSecondaryBrush}" />
                                        </Viewbox>
                                    </Button>
                                </Grid>
                            </Button>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>

        <!-- Breadcrumb bar -->
        <components:BreadcrumbBar DockPanel.Dock="Top"
                                   FilePath="{Binding TabManager.ActiveTab.FilePath}" />

        <!-- Barre d'etat -->
        <components:StatusBar DockPanel.Dock="Bottom" />

        <!-- Zone principale : panneau lateral + editeur + markdown -->
        <Grid ColumnDefinitions="Auto,*">
            <!-- Panneau lateral -->
            <components:SidePanel Grid.Column="0"
                                   IsVisible="{Binding Settings.IsSidePanelVisible}" />

            <!-- Zone principale (Column 1) : editeur+terminal + markdown preview -->
            <Grid Grid.Column="1" ColumnDefinitions="*,Auto">
                <!-- Editeur + Terminal (Column 0) -->
                <Grid Grid.Column="0" RowDefinitions="*,Auto,Auto">
                    <!-- Editeurs (Row 0) -->
                    <Grid Row="0" x:Name="EditorGrid">
                        <!-- Primary editor -->
                        <components:EditorControl x:Name="PrimaryEditor"
                                                  DataContext="{Binding TabManager.ActiveTab}" />

                        <!-- Secondary editor (split view) -->
                        <components:EditorControl x:Name="SecondaryEditor"
                                                  DataContext="{Binding TabManager.SecondaryTab}"
                                                  IsVisible="{Binding TabManager.IsSplitViewActive}" />

                        <!-- Panneau Rechercher/Remplacer -->
                        <dialogs:FindReplacePanel DataContext="{Binding FindReplaceViewModel}"
                                                  VerticalAlignment="Top"
                                                  HorizontalAlignment="Right"
                                                  Margin="0,8,8,0" />

                        <!-- Palette de commandes -->
                        <Border IsVisible="{Binding CommandPalette.IsVisible}"
                                VerticalAlignment="Top"
                                HorizontalAlignment="Center"
                                Margin="0,20,0,0"
                                Background="{DynamicResource ToolbarBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="6"
                                Width="500"
                                MaxHeight="400"
                                BoxShadow="0 4 12 2 #40000000"
                                ZIndex="100">
                            <StackPanel>
                                <TextBox Text="{Binding CommandPalette.Query, Mode=TwoWay}"
                                         Watermark="Tapez une commande..."
                                         Margin="8"
                                         x:Name="CommandPaletteInput"
                                         KeyDown="OnCommandPaletteKeyDown" />
                                <ListBox ItemsSource="{Binding CommandPalette.Items}"
                                         SelectedIndex="{Binding CommandPalette.SelectedIndex, Mode=TwoWay}"
                                         MaxHeight="320"
                                         x:Name="CommandPaletteList"
                                         DoubleTapped="OnCommandPaletteDoubleTapped">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Grid ColumnDefinitions="*,Auto" Margin="8,4">
                                                <TextBlock Text="{Binding Label}" VerticalAlignment="Center" />
                                                <TextBlock Grid.Column="1" Text="{Binding Shortcut}"
                                                           Foreground="{DynamicResource TextMutedBrush}" FontSize="11"
                                                           VerticalAlignment="Center" />
                                            </Grid>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </StackPanel>
                        </Border>

                        <!-- Clipboard History overlay -->
                        <Border IsVisible="{Binding Clipboard.IsVisible}"
                                VerticalAlignment="Top"
                                HorizontalAlignment="Center"
                                Margin="0,20,0,0"
                                Background="{DynamicResource ToolbarBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="6"
                                Width="450"
                                MaxHeight="400"
                                BoxShadow="0 4 12 2 #40000000"
                                ZIndex="100">
                            <Grid RowDefinitions="Auto,*,Auto">
                                <TextBox Text="{Binding Clipboard.Filter, Mode=TwoWay}"
                                         Watermark="Filtrer l'historique..."
                                         Margin="8"
                                         x:Name="ClipboardFilterInput"
                                         KeyDown="OnClipboardHistoryKeyDown" />
                                <ListBox Grid.Row="1"
                                         ItemsSource="{Binding Clipboard.FilteredItems}"
                                         SelectedIndex="{Binding Clipboard.SelectedIndex, Mode=TwoWay}"
                                         MaxHeight="220"
                                         DoubleTapped="OnClipboardHistoryDoubleTapped">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding}"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxLines="1"
                                                       FontFamily="Cascadia Code, Consolas, monospace"
                                                       FontSize="11"
                                                       Padding="8,4" />
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                                <Border Grid.Row="2"
                                        Background="{DynamicResource SurfaceBrush}"
                                        Padding="8,6"
                                        CornerRadius="0,0,6,6"
                                        MaxHeight="80">
                                    <TextBlock Text="{Binding Clipboard.PreviewText}"
                                               FontFamily="Cascadia Code, Consolas, monospace"
                                               FontSize="10"
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               TextWrapping="Wrap"
                                               MaxLines="3"
                                               TextTrimming="CharacterEllipsis" />
                                </Border>
                            </Grid>
                        </Border>

                        <!-- Go-to-line overlay -->
                        <Border IsVisible="{Binding IsGoToLineVisible}"
                                VerticalAlignment="Top"
                                HorizontalAlignment="Center"
                                Margin="0,20,0,0"
                                Background="{DynamicResource ToolbarBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="6"
                                Width="300"
                                BoxShadow="0 4 12 2 #40000000"
                                ZIndex="100"
                                Padding="12">
                            <StackPanel Spacing="6">
                                <TextBlock Text="Aller a la ligne" FontWeight="SemiBold" FontSize="13" />
                                <TextBox Text="{Binding GoToLineInput, Mode=TwoWay}"
                                         Watermark="Numero de ligne..."
                                         x:Name="GoToLineInput"
                                         KeyDown="OnGoToLineKeyDown" />
                                <TextBlock Text="{Binding GoToLineError}"
                                           Foreground="Red"
                                           FontSize="11"
                                           IsVisible="{Binding GoToLineError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- GridSplitter terminal -->
                    <GridSplitter Grid.Row="1" Height="4"
                                  IsVisible="{Binding IsTerminalVisible}"
                                  Background="{DynamicResource BorderBrush}" />

                    <!-- Terminal -->
                    <components:TerminalPanel Grid.Row="2" Height="250"
                                              x:Name="TerminalPanel"
                                              IsVisible="{Binding IsTerminalVisible}" />
                </Grid>

                <!-- Right panels (Column 1) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <components:SnippetManagerPanel Width="300"
                                                     x:Name="SnippetManager"
                                                     IsVisible="{Binding IsSnippetManagerVisible}" />
                    <components:MarkdownPreviewPanel Width="400"
                                                      x:Name="MarkdownPreview"
                                                      IsVisible="{Binding IsMarkdownPreviewVisible}" />
                </StackPanel>
            </Grid>
        </Grid>
    </DockPanel>
</Window>
